name: Build static OpenSSL 3.x for Android ARM64

on:
  workflow_dispatch:
    inputs:
      openssl_version:
        description: "OpenSSL version (e.g. 3.3.2)"
        required: true
        default: "3.6.0"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_NDK_VERSION: r27d
      API_LEVEL: 21
      TARGET: android-arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            perl \
            ca-certificates

      - name: Install Android NDK
        run: |
          curl -fsSL https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip -o ndk.zip
          unzip -q ndk.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-${ANDROID_NDK_VERSION}" >> $GITHUB_ENV

      - name: Download OpenSSL
        run: |
          curl -fsSL https://www.openssl.org/source/openssl-${{ github.event.inputs.openssl_version }}.tar.gz -o openssl.tar.gz
          tar xzf openssl.tar.gz

      - name: Configure OpenSSL (static, arm64, clang)
        run: |
          export ANDROID_NDK_ROOT=${ANDROID_NDK_HOME}
          export PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

          export ANDROID_API=${API_LEVEL}
          export CC=aarch64-linux-android${ANDROID_API}-clang
          export CXX=aarch64-linux-android${ANDROID_API}-clang++
          
          export CPPFLAGS="-DANDROID -fPIC"
          export CFLAGS="-fPIC"
          export LDFLAGS="-static"

          cd openssl-${{ github.event.inputs.openssl_version }}

          ./Configure android-arm64 \
            no-shared \
            no-tests \
            no-dso \
            no-engine \
            no-unit-test \
            --prefix=$PWD/out

      - name: Build OpenSSL
        run: |
          cd openssl-${{ github.event.inputs.openssl_version }}
          make -j$(nproc)
          make install_sw

      - name: Strip binary
        run: |
          $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            openssl-${{ github.event.inputs.openssl_version }}/out/bin/openssl

      - name: Verify binary
        run: |
          file openssl-${{ github.event.inputs.openssl_version }}/out/bin/openssl
          ldd openssl-${{ github.event.inputs.openssl_version }}/out/bin/openssl || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-${{ github.event.inputs.openssl_version }}-android-arm64-static
          path: openssl-${{ github.event.inputs.openssl_version }}/out/bin/openssl
